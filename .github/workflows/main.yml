name: Simple Tar Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build and save images
        run: |
          docker compose build
          
          docker save backend:latest -o backend.tar
          docker save frontend:latest -o frontend.tar
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð´ÐµÐ¿Ð»Ð¾Ñ
          cat > deploy.sh << 'EOF'
          #!/bin/bash
          set -e
          echo "ðŸ”„ Loading Docker images..."
          docker load -i backend.tar
          docker load -i frontend.tar
          
          echo "ðŸš€ Starting/updating containers (preserving database)..."
          # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ app-ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹, Ð‘Ð” Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð°ÐµÑ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ
          docker compose -f docker-compose.yml stop lingua-backend lingua-frontend || true
          
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ð¼Ð¸ Ð¾Ð±Ñ€Ð°Ð·Ð°Ð¼Ð¸
          docker compose -f docker-compose.yml up -d lingua-backend lingua-frontend
          
          echo "âœ… App deployment complete!"
          docker images | grep -E "(lingua-backend|lingua-frontend)"
          EOF

      - name: Prepare initial deployment if needed
        uses: appleboy/ssh-action@v1.2.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.KEY }}
          script: |
            cd /opt/app
            # Ð•ÑÐ»Ð¸ ÑÑ‚Ð¾ Ð¿ÐµÑ€Ð²Ñ‹Ð¹ Ð´ÐµÐ¿Ð»Ð¾Ð¹, ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð‘Ð”
            if [ ! -f .initialized ]; then
              echo "ðŸ”„ First deployment - setting up database..."
              docker compose -f docker-compose.yml up -d database
              sleep 30
              touch .initialized
            else
              echo "âœ… Database already initialized - preserving data"
            fi

      - name: Upload files to server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SERVER_HOST }}  
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.KEY }}
          source: "backend.tar,frontend.tar,deploy.sh,docker-compose.yml"
          target: "/opt/app/"
          strip_components: 1

      - name: Execute deployment
        uses: appleboy/ssh-action@v1.2.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.KEY }}
          script: |
            cd /opt/app
            chmod +x deploy.sh
            ./deploy.sh
