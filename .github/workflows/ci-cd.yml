name: CI/CD Pipeline

on:
  push:
    branches: [ develop, main ]
  pull_request:
    branches: [ main ]

jobs:
  code-quality:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: TypeScript compilation check
      run: npm run build

    - name: TypeScript type checking
      run: npx tsc --noEmit

    - name: Run ESLint
      run: npm run lint

    - name: Run tests
      run: npm test

  build-and-deploy:
    runs-on: ubuntu-latest
    
    needs: code-quality
    
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '24'

    - name: Install dependencies and build
      run: |
        npm ci          # Установить зависимости
        npm run build   # Собрать проект (TypeScript → JavaScript)

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      run: |
        docker build \
          -t my-app:latest \          # Тег 'latest' для простоты
          -t my-app:${{ github.sha }} \  # Тег с хешем коммита для точной идентификации
          .                           # Контекст сборки - текущая директория

    - name: Save Docker image
      run: |
        # Сохраняем Docker образ в tar файл для передачи на сервер
        docker save my-app:latest > image.tar

    - name: Deploy to production server
      uses: appleboy/ssh-action@v1.0.3
      with:
        # Хост сервера из секретов GitHub
        host: ${{ secrets.PRODUCTION_SERVER_HOST }}
        # Пользователь для подключения из секретов
        username: ${{ secrets.PRODUCTION_SERVER_USER }}
        # Приватный SSH ключ из секретов
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        # Команды, которые выполнятся на удаленном сервере
        script: |
          # Выводим сообщение о начале деплоя
          echo "Deploying application..."
          
          # Загружаем Docker образ из tar файла
          docker load -i /tmp/image.tar
          
          # Останавливаем старый контейнер (если существует)
          # || true - чтобы команда не падала если контейнера нет
          docker stop my-app-production || true
          
          # Удаляем старый контейнер (если существует)
          docker rm my-app-production || true
          
          # Запускаем новый контейнер с параметрами:
          docker run -d \                    # -d = detached mode (в фоне)
            --name my-app-production \       # Имя контейнера
            -p 80:3000 \                    # Проброс порта 80 host → 3000 container
            -p 443:3000 \                   # Проброс порта 443 host → 3000 container  
            -e NODE_ENV=production \        # Переменная окружения
            --restart unless-stopped \      # Автоматически перезапускать если упал
            my-app:latest                   # Используемый образ
          
          # Очищаем Docker систему (удаляем неиспользуемые образы, контейнеры)
          docker system prune -f
          
          # Удаляем временный tar файл
          rm /tmp/image.tar
          
          echo "Deployment completed successfully!"
